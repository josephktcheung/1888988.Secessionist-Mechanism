归并国机制改进建议
==================

核心假设：归并国叛乱是民族主义/文化型叛乱，他们想要脱离控制者并加入具有相同主要文化的国家（不一定是邻国 - 飞地可能存在，例如欧洲的俄罗斯飞地）。他们在胜利后成为支持者的附庸。

本文档提供了一个简化的、平衡的方法来修复归并国机制，优先考虑：
1. 修复关键的游戏破坏性问题
2. 在可行的情况下保持历史准确性
3. 最小化复杂性以减少错误和利用
4. 尽可能使用现有游戏系统

案例研究：波萨德叛乱 - 有常识的决策与不合理决策的对比
======================================================

为了说明当前归并国机制的问题，让我们审视一个真实的游戏场景，它展示了当前系统的荒谬性：

关于防止过多通知的重要说明：
EU5有大量的地点，如果每个叛乱都向主导文化国家发送支援请求，将产生过多的游戏通知，严重损害游戏体验。因此，叛乱AI必须在发送任何支援请求之前做出有常识的预评估决策。这不仅符合逻辑（叛乱者在发送信使说服国王/皇帝之前会评估潜在支持者），而且对游戏质量至关重要。

场景设定：
- 玩家在1337年控制大元（中华帝国）
- 波萨德，一个靠近黑海的地点，原本由金帐汗国（一个与莫斯科公国接壤的蒙古国家）拥有
- 莫斯科公国从金帐汗国征服了波萨德
- 波萨德有1669名蒙古人（游戏开始时占波萨德总人口的23.6%）
- 这些蒙古人对莫斯科公国的统治不满，开始分离主义叛乱
- 金帐汗国仍然存在，是莫斯科公国的邻国，也是波萨德的原所有者
- 然而，叛乱寻求"主导"蒙古文化的国家支持：大元（6000多公里外），忽略了更符合逻辑的选择金帐汗国（原所有者和邻国）

当前游戏行为（不合理）：
1. 游戏自动将大元识别为蒙古文化的主导国家
2. 当叛乱爆发时，大元在第1天被强制加入战争
3. 大元必须在距离其首都汗八里（北京）6000多公里的东欧作战
4. 玩家没有选择权 - 他们被拖入一场无法实际支持的战争
5. 战争可能持续数年，玩家由于距离无法有效参与
6. 正如一位玩家评论："玩大元天天被AI拉着在东欧打，但是又没有军通过不去AI又死活不投，有一次战争持续了快10年"（来源：玩家报告）

有常识的决策过程（应该发生的情况）：

第一步：叛乱的初步评估
- 波萨德的蒙古叛乱者应该首先考虑原所有者：金帐汗国
- 金帐汗国是波萨德的原所有者（在莫斯科公国征服之前）
- 金帐汗国是一个与莫斯科公国接壤的附近蒙古国家
- 从常识来看，叛乱者会首先向金帐汗国派遣信使（原所有者和邻国），而不是向6000公里外的大元
- 然而，当前游戏系统自动选择大元作为"主导"文化国家，忽略了更符合逻辑的选择金帐汗国（原所有者和邻国）
- 这与拜占庭案例类似：奥斯曼（原所有者和邻国）应该优先于埃雷特尼德（文化主导但不是原所有者）

第二步：信使的旅程（如果他们真的向大元派遣了信使）
- 一个信使团队在1337年从波萨德（黑海附近）前往汗八里（北京）
- 现实的旅行时间：单程9-18个月
- 影响旅行的因素：
  * 穿越金帐汗国领土（可能没有许可）
  * 穿越山口（冬季无法通行）
  * 边境的政治延误
  * 丝绸之路沿线的土匪和危险
- 往返时间：总共3-4年
- 游戏目前强制大元在第1天加入，这在物理上是不可能的
- 注意：EU5有外交范围（默认1000）和外交延迟（每次通信间隔1个月），但这些对于现实的长距离通信来说是不够的。游戏应该在允许支援请求之前检查国家是否在外交范围内。

第三步：皇帝的问题
当（如果）信使到达大元朝廷时，有常识的皇帝会问：

问题1："莫斯科与我天朝孰大？"
- 皇帝想知道相对实力
- 即使莫斯科公国很小，距离也使这个问题无关紧要
- 有常识的皇帝会认识到在6000公里外投射力量是不可能的

问题2："有无陆路可通啊？"
- 皇帝会检查是否有可行的路线
- 即使路线存在，也是6000公里穿过可能敌对的领土
- 在如此距离支持叛乱的物流是不可克服的

问题3："我们能否实际到达并支持他们？"
- 皇帝的 cabinet 可能会说："我们可以轻松击败莫斯科公国"
- 但皇帝会回应："是的，但莫斯科公国距离我们的首都6000公里"
- 有常识的回应：解雇信使甚至处决他们以浪费皇帝的时间

第四步：有常识的决定
有常识的皇帝会：
- 认识到支持6000公里外的叛乱在财政和物理上是不可能的
- 理解即使他们能赢，也无法在如此距离有效投射力量
- 意识到成本（资源、时间和机会）远远超过任何潜在利益
- 选择保持中立或完全拒绝请求
- 专注于更重要的、更接近家乡的事务

当前AI行为（实际发生的情况）：
- AI大元："同文化？必须支持！立即加入战争！"
- 不考虑距离
- 不考虑后勤
- 不考虑成本效益分析
- 不考虑物理不可能性
- 玩家被强制进入一场他们无法有效参与的10年战争

对比：

有常识的人/皇帝/玩家：
- 询问关于距离、路线和可行性的实际问题
- 考虑成本效益比
- 认识到物理和财政限制
- 基于常识做出决定
- 会解雇或拒绝不可能的请求

当前游戏AI：
- 自动强制国家参战
- 忽略距离和后勤
- 无成本效益分析
- 不考虑物理不可能性
- 强制玩家进入他们无法控制的情况

解决方案：
改进的系统应该：
1. 在考虑支持之前检查距离，使用现有函数：
   * border_distance_to(rebellion_country) 计算距离
   * 如果距离 > 2000，不自动召唤他们
2. 给国家拒绝不可能请求的选项
3. 使用距离计算优先考虑附近的同文化国家而不是遥远的国家
4. 允许基于可行性的有常识决策
5. 通过检查以下内容来防止荒谬情况，如大元在东欧作战：
   * 距离是否超过合理限制（例如，小型叛乱 > 2000，大型叛乱 > 3000）
   * 获得军事通行权的可能性：国家是否能够实际通过中间国家获得军事通行权以到达叛乱地点？如果不存在可行路线，则不支持

这个案例研究清楚地展示了为什么当前系统是破碎的，以及为什么提出的改进对于历史准确性和游戏质量都是必要的。

莫斯科公国玩家的视角（防御方）
============================================

当玩家扮演莫斯科公国（或任何征服不同文化领土的国家）时，归并国机制会产生几个严重问题：

1. 不可预测的大国干预：
- 莫斯科公国必须考虑大元（中华帝国的强大力量）是否会干预并支持波萨德的叛乱
- 这是不合理的，因为莫斯科公国的关系是与金帐汗国（其旧的鞑靼宗主），而不是大元
- 莫斯科公国帮助金帐汗国从其他俄罗斯国家收集贡品，但莫斯科公国从未为大元收集过贡品
- 没有历史或逻辑上的理由说明大元会关心6000公里外的小规模叛乱
- 然而游戏强制大元支持叛乱，创造了一个不可预测和不合理的威胁

2. 不可避免的战争参与：
- 如果归并国叛乱，无论以下哪种情况，莫斯科公国都会被拖入战争：
  * 莫斯科公国直接拥有土地
  * 莫斯科公国释放附庸来帮助管理领土
- 避免这种情况的唯一方法是及时转换蒙古文化，这几乎是不可能的

3. 文化转换的不可能性：
- 由于现有的EU5文化转换机制，莫斯科公国几乎不可能转换蒙古文化
- 蒙古文化具有更高的文化传统（5630.14，世界排名第1），而莫斯科公国的文化影响力（322.77）要低得多
- 当前的转换是按人口数量进行的，波萨德有1669名蒙古人
- 即使能够转换，也需要很长时间，最有可能由于以下惩罚而保持0%：
  * 新征服领土的控制度低
  * 文化影响力与文化传统的不平衡
  * 其他转换惩罚
- 这意味着莫斯科公国被困在永久性的叛乱风险中，无法缓解

4. 战争限制：
- 一旦被拖入归并国战争，莫斯科公国面临许多限制：
  * 战争期间各种外交行动被禁用（例如，某些附庸互动、某些外交提案）
  * 军事和食物通行权请求被阻止（block_when_at_war = yes）
  * 无法专注于其他战略目标，同时进行不必要的战争
  * 战争疲惫累积，影响稳定性和其他机制
  * 资源从扩张或发展转移到本不应该发生的战争

5. 无法控制和平：
- 如果莫斯科公国释放附庸来管理领土，附庸成为战争领导者
- 莫斯科公国无法控制和平谈判
- AI附庸可能做出次优决策（例如，白和平而不是吞并叛乱者）
- 莫斯科公国承担所有战争成本，但无法控制结果

大元玩家的视角（被迫支持者）
=======================================================

当玩家扮演大元（或任何文化主导国家）时，归并国机制创造了一个荒谬的情况：

1. 不想要的全球保护者角色：
- 大元成为世界上所有蒙古人的事实上的"保护者"
- 每当世界上任何地方爆发蒙古归并国叛乱时，中华帝国都会被自动召唤参战
- 这在历史上是荒谬的：中国皇帝不会关心遥远土地上的小规模叛乱

2. 全球战争义务：
- 来自各个地点的叛乱者可以将大元拖入战争：
  * 克里米亚的斯拉维扬斯克/波萨德（6000多公里外）
  * 安纳托利亚的库鲁（5000多公里外）
  * 美索不达米亚的巴士拉（4000多公里外）
  * 阿富汗的加兹尼（3000多公里外）
  * 任何其他有蒙古人口的地点
- 皇帝没有权力拒绝这些召唤
- 大元被迫在整个已知世界作战

3. 不可能的物流：
- 大元无法实际支持数千公里外的叛乱
- 需要通过多个国家获得军事通行权（通常不可能获得）
- 需要食物通行权以避免军队饥饿
- 在如此距离上投射力量的物流是不可克服的
- 然而游戏强制大元参与，创造了持续数年的僵局

4. 没有战略利益：
- 大元从支持遥远的叛乱中一无所获
- 归并国成为附庸，但数千公里外的飞地附庸提供：
  * 最小的经济利益（由于距离导致控制度低）
  * 没有战略价值（无法有效投射力量）
  * 只有外交和军事负担
- 成本（资源、时间、机会）远远超过任何潜在利益

5. 战略规划被打乱：
- 大元的战略目标（管理中国、处理附近威胁、内部发展）被打乱
- 皇帝无法有效规划，因为不可预测的全球战争召唤
- 资源浪费在不可能的战争上，而不是用于有意义的扩张或发展

6. 历史荒谬性：
- 历史上，中国皇帝会拒绝或处决来自遥远土地寻求帮助的信使
- 游戏强制相反：自动接受和参与
- 这违反了历史逻辑和常识

需要修复的核心问题
==================

1. 强制参战且无法拒绝
2. 被强制参战时触发撕停战惩罚
3. 被强制参战时导致联统破裂
   - 示例1：英格兰与法国有联统（英格兰为宗主）
     * 在英格兰控制的地区爆发法兰西叛乱
     * 法国（主导法兰西文化）被迫加入叛乱方（攻击英格兰）
     * 联统立即破裂，因为 union_of_crowns_pact 中有 break_on_war = yes
     * 结果：法国被迫与自己的宗主国作战，破坏联统
   - 示例2（已验证）：法国与那不勒斯有联统（法国为宗主）
     * 在法国控制的达尔马提亚地区爆发那不勒斯人叛乱
     * 那不勒斯（主导那不勒斯文化）被迫加入叛乱方（攻击法国）
     * 联统在战争开始当天立即破裂
     * 结果：那不勒斯被迫与自己的宗主国（法国）作战，破坏联统，那不勒斯获得新统治者（火星人，指随机生成的统治者）
     * 来源：玩家报告："我联统了那不勒斯然后达尔马提亚爆了那不勒斯人叛乱就把那不勒斯拽过来给我联统打断上了一个火星人当那不勒斯国王"
   - 重要：根据游戏概念，如果附庸的宗主国拥有不同文化，附庸可以成为文化主导国家。这意味着附庸（封臣、采邑或联统附庸）如果是主导文化国家，可能被迫支持针对自己宗主国的叛乱！
4. 荒谬的距离支持请求（例如，大元支持东欧叛乱）
5. 宗主国被强制参战但无控制权

简化解决方案
============

1. 简单拒绝机制（关键修复）

不采用复杂的决策系统，而是在强制国家参与内战之前添加简单检查：

1.1 基本距离、军事通行权和土地渴望检查
- 在自动召唤同文化国家参与内战之前，检查：
  * 距离：使用现有的 border_distance_to 函数（游戏中已有）
  * 如果距离 > 2000，不自动召唤他们
  * 军事通行权可行性：国家是否能够实际通过中间国家获得军事通行权以到达叛乱地点？
  * 如果不存在可行路线（例如，被敌对国家阻挡，距离太远），不自动召唤他们
  * 土地渴望：使用现有的 conquer_desire(location_owner) 函数（AI已用于扩张）
  * 如果 conquer_desire < 阈值（例如 < 10），不自动召唤他们
  * 对于AI，获得新附庸（归并国）更像是土地征服，因此土地渴望是主要因素
  * 这防止国家支持他们不想要的土地的叛乱
  * 基于距离的支援渴望：类似于联盟形成，其中 alliance.txt 中的 border_distance = -0.05 对远距离国家施加惩罚（较近的国家更可能形成联盟），将基于距离的渴望应用于归并国支援评估。使用 border_distance_to 和负乘数（例如 -0.05 或 -0.1）来优先考虑较近的国家而不是较远的国家。这使系统与现有的联盟机制保持一致。
  * 停战检查（给Paradox的问题）：是否应该排除与防御方有活跃停战的国家作为支持者？例如，如果卡斯蒂利亚与法国有停战，卡斯蒂利亚叛乱者请求卡斯蒂利亚支持他们对抗法国，这是否被视为撕停战？ 
    * 选项A：在预评估期间跳过有活跃停战的国家（完全防止选择）
    * 选项B：允许选择但豁免撕停战惩罚（已在1.3中建议）
    * 这是Paradox需要根据他们对停战机制的解释来考虑的设计问题
  * 飞地惩罚（仅AI）：游戏已有 would_fracture_recipient_too_much 机制，对创建不连接领土（飞地）的和约施加惩罚。如果支持叛乱会为支持者创建飞地附庸（归并国领土与支持者现有领土不连接），AI应应用重大惩罚或完全拒绝支持。 
    * 为什么仅AI：一些玩家可能出于战略原因想要飞地附庸（例如，创建CB、战略定位）。AI不知道如何有效利用飞地附庸，因此检查应仅适用于AI国家。玩家应始终可以选择支持会创建飞地的叛乱（见下面的"游戏设置选项"）。
    * 为什么AI会被惩罚飞地：EU5有一个控制机制，其中控制（决定税收基础、征召兵、人力、水手以及转换/同化速度）主要取决于与首都的接近度。接近度通过道路和沿海的海上存在传播。不连接的领土（飞地）与首都的接近度非常低，导致最大控制非常低，提供的经济利益极小。AI不知道如何有效利用飞地附庸进行战略目的，因此AI应拒绝会创建飞地的支援请求。
    * 注意：这并不意味着只有邻国可以支持。检查应验证叛乱的领土是否与支持者的任何现有领土（不仅仅是首都）连接。拥有通过自己领土的陆桥的国家仍然可以支持，但支持会创建孤立附庸的叛乱应该对AI进行惩罚。
    * 这防止AI国家支持会创建战略上有问题的、经济价值极小的飞地附庸的叛乱。
- 使用现有游戏函数的简单阈值检查，无复杂计算

1.2 简单拒绝选项
- 当国家将被强制参与内战时，显示弹窗：
  * "支持[叛乱名称]对抗[防御方]的战争？"
  * 选项："是" / "否"
- 如果"否"：国家不加入，无惩罚
- 如果"是"：国家像以前一样加入
- 这给玩家控制权，无需复杂系统

1.3 豁免强制参与的惩罚
- 如果国家拒绝或被强制参战，豁免：
  * 撕停战惩罚（稳定性、战争疲惫、敌对度）
  * 联统破裂
- 添加简单标志：自动召唤时 forced_civil_war_participant = yes
- 在应用惩罚之前检查此标志

实施：
- 最少的代码更改
- 使用现有距离函数
- 简单布尔标志系统
- 低错误风险

2. 民族主义/文化型叛乱的简单预评估（高优先级）

2.1 核心评估标准
由于归并国叛乱是想要加入相同文化国家的民族主义/文化型叛乱（不一定是邻国 - 飞地可能存在），评估应关注：

- 相同主要文化检查：只考虑与叛乱具有相同主要文化的国家（这已经是情况，但应该明确）
- 距离检查：相同文化国家是否在合理距离内？（使用现有的 border_distance_to）
  * 主要检查：1000距离内的国家（附近）- 优先但不强制
  * 次要检查：2000距离内的国家（如果没有附近国家通过其他检查）
  * 扩展检查：3000距离内的国家（对于大型叛乱或如果没有更近的国家通过检查）
  * 这反映了民族主义叛乱会首先逻辑地寻求附近相同文化国家的支持，但飞地可能存在（例如，欧洲的俄罗斯飞地想要加入俄罗斯，即使不直接相邻）
  * 距离是可行性的一个因素，不是绝对要求
- 土地渴望检查：国家是否真的想要叛乱的领土？（使用现有的 conquer_desire 函数）
  * 游戏已有 conquer_desire(location_owner) 函数，AI用于扩张决策
  * 该函数考虑：距离、国家规模、时代、首都距离、海上距离等
  * 仅在 conquer_desire > 阈值（例如 > 10 或 > 20）时发送支援请求
  * 对于AI，获得新附庸（归并国）更像是土地征服，因此土地渴望是主要因素
  * 这防止国家支持他们不想要的土地的叛乱（例如，大元支持遥远的东欧叛乱）
- 基于距离的优先级（类似于联盟渴望）：游戏已有联盟的基于距离的渴望（alliance.txt 中的 border_distance = -0.05）。应用类似逻辑：
  * 使用 border_distance_to 和负乘数（例如 -0.05 或 -0.1）来优先考虑较近的国家
  * 较近的相同文化国家应该优先于较远的国家
  * 这加强了距离检查，并使系统与现有游戏机制保持一致
- 军事通行权可行性：国家是否能够实际获得军事通行权以到达叛乱地点？
  * 检查是否存在通过中间国家的可行路线
  * 如果不存在路线（被敌对国家阻挡，距离太远），从评估中排除
- 停战检查（给Paradox的问题）：是否应该在预评估期间排除与防御方有活跃停战的国家？例如，如果卡斯蒂利亚与法国有停战，卡斯蒂利亚叛乱者请求卡斯蒂利亚支持他们对抗法国，这是否被视为撕停战？
  * 选项A：在预评估期间跳过有活跃停战的国家（完全防止选择）
  * 选项B：允许选择但豁免撕停战惩罚（已在1.3中建议）
  * 这是Paradox需要根据他们对停战机制和历史先例的解释来考虑的设计问题
- 飞地检查（仅AI）：支持叛乱会为支持者创建飞地附庸（不连接的领土）吗？
  * 游戏已有 would_fracture_recipient_too_much 机制，对创建不连接领土的和约施加惩罚
  * 为什么AI会被惩罚飞地：控制（决定税收基础、征召兵、人力、水手以及转换/同化速度）主要取决于与首都的接近度。不连接的领土接近度非常低，导致最大控制非常低，经济利益极小。AI不知道如何有效利用飞地附庸进行战略目的（例如，CB创建），因此AI应拒绝会创建飞地的支援请求。
  * 玩家选择：玩家可能出于战略原因想要飞地附庸（CB创建、定位等），因此玩家应始终可以选择支持会创建飞地的叛乱（由游戏设置控制 - 见下面的"游戏设置选项"）。
  * 使用 is_connected_to 触发器检查叛乱的领土是否与支持者的任何现有领土（不仅仅是首都）连接
  * 重要：这并不意味着只有邻国可以支持。拥有通过自己领土的陆桥的国家仍然可以支持叛乱。检查防止AI支持会创建与支持者没有陆路连接的孤立附庸的叛乱。
  * 如果领土将不连接（飞地），AI应应用重大惩罚或完全拒绝支持
  * 这防止AI国家支持会创建战略上有问题的、经济价值极小的飞地附庸的叛乱

2.2 简单优先级系统
评估应按以下顺序优先考虑国家（最符合逻辑的优先）：

优先级1：原所有者（如果仍然存在且相同文化）
- 如果叛乱领土之前由相同文化的国家拥有且该国家仍然存在，优先考虑该国家
- 这在历史上是符合逻辑的：最近失去土地的人民自然会寻求前统治者的帮助
- 示例：如果拜占庭征服了奥斯曼土地，土耳其叛乱出现，奥斯曼（原所有者）应该优先于埃雷特尼德（文化主导但不是原所有者）
- 仅当原所有者与叛乱具有相同主要文化时适用

优先级2：相邻的相同文化国家
- 与防御方接壤且共享相同文化的国家
- 更容易提供支持（更容易获得军事通行权，距离更近）
- 使用 border_distance_to 识别邻国

优先级3：文化主导国家（当前系统）
- 对叛乱文化具有文化主导地位的国家
- 只有在没有原所有者或邻国通过检查时才考虑
- 这是当前系统的主要选择方法，但应该是较低优先级

评估过程：
- 按优先级顺序评估相同文化国家（原所有者 > 邻国 > 文化主导）
- 在每个优先级层级内，按距离评估（最近优先，使用 border_distance_to）
- 对每个候选国家应用所有检查（距离、土地渴望、军事通行权、停战、飞地）
- 在第一个通过所有检查的国家处停止
- 仅向该国家发送请求
- 如果被拒绝，按优先级顺序移动到下一个国家
- 防止过多通知，简单逻辑，专注于历史和逻辑优先级

注意：此优先级系统使选择更加符合历史逻辑。例如，在拜占庭案例中，如果奥斯曼仍然作为邻国存在，来自前奥斯曼土地的土耳其叛乱应该首先向奥斯曼寻求帮助，而不是埃雷特尼德（它是文化主导但不是原所有者）。

实施：
- 使用现有距离函数（border_distance_to）
- 使用现有土地渴望函数（conquer_desire）
- 简单优先级：最近的相同文化国家优先（但不限于邻国）
- 简单百分比检查（rebel_size / defender_population）
- 无复杂计算
- 易于测试和调试

3. 宗主国战争领导者控制（高优先级）

3.1 简单修复
- 当宗主国被强制参与附庸的内战时，使宗主国成为战争领导者
- 在 on_civil_war_start 事件中的单行更改
- 给玩家对和平谈判的控制权
- 允许宗主国召唤盟友参战（例如，拜占庭可以召唤特拉布宗）
   - 重要：当盟友加入战争时，他们自动与所有战争参与者共享军事和食物通行权。这是因为：
     * 联盟关系包括 military_access = yes（在 alliance.txt 第10行）
     * is_fighting_war_together_with 触发器自动授予通行权（military_access.txt 和 food_access.txt 在 request/offer enabled 中检查 not = { is_fighting_war_together_with = scope:recipient }，意味着一起参战时通行权是自动的）
   - 但是，如果防御方无法召唤盟友（例如，附庸是战争领导者），或者如果盟友不加入，防御方（拜占庭）可能仍无法到达支持者（埃雷特尼德）
   - 飞地检查如何帮助（仅AI）：在拜占庭场景中，埃雷特尼德（AI）与叛乱地点之间被阿希斯（另一个国家）分隔。如果埃雷特尼德支持叛乱，归并国成为埃雷特尼德的附庸，归并国领土将不会与埃雷特尼德的现有领土连接（阿希斯在中间）。这将创建一个控制极低、经济价值极小的飞地附庸。通过飞地检查（仅AI），AI埃雷特尼德应该拒绝支援请求，从而完全避免这个有问题的局面。但是，如果玩家控制埃雷特尼德，他们可以选择支持，如果他们出于战略原因想要飞地附庸（由游戏设置控制）。
   - 关键问题：没有军事通行权，防御方的获胜条件严重受限：
     - 无法进行战斗（需要到达敌方领土）
     - 无法占领敌方领土（需要到达敌方）
     - 只能依赖：海上封锁（如果有海军通行权）、战争目标的持续战争分数（每月2%，最多25%）、敌方战争疲惫，或盟友赢得战斗
     - 这造成了防御方无法主动获胜，只能被动等待的僵局
   - 需要额外修复：允许在防御性内战中请求军事通行权，或
   - 允许宗主国在作为附庸内战的战争领导者时向盟友请求军事通行权
- 不需要复杂逻辑

4. 简化决策系统（可选增强）

如果实施决策系统，保持简单（除非游戏设置设置为"忽略所有叛乱支援请求"）：

4.1 仅两个选项
- "支持叛乱" - 在爆发时加入战争
- "拒绝" - 不加入，无惩罚

注意：游戏设置可以完全覆盖此功能 - 请参阅下面的"游戏设置选项"部分。

4.2 简单条件
- 仅在以下情况下显示决策：
  * 国家在距离阈值内（中型叛乱2000，大型叛乱3000）
  * 叛乱足够大（防御方人口的5%+）或国家有战略利益（对手、处于战争状态等）
  * 军事通行权可行：国家能够实际获得军事通行权以到达叛乱地点
  * 土地渴望：国家确实想要该领土（conquer_desire > 阈值，例如 > 10）
  * 飞地检查（仅AI）：领土将与支持者的现有领土连接（不是飞地附庸）- 使用 is_connected_to 触发器检查与支持者任何领土的连接，不仅仅是首都。玩家可以通过游戏设置选择支持会创建飞地的叛乱。
- 无复杂多因素评估
- 使用现有游戏函数的简单布尔检查

4.3 无复杂奖励/惩罚
- 如果支持：加入战争，如果成功可以获得利益
- 如果拒绝：无惩罚（已豁免撕停战）
- 保持简单

实施优先级
==========

第一阶段（热修复 - 关键）：
1. 豁免强制参与的撕停战（1.3）
2. 防止联统破裂（1.3）
3. 添加简单距离检查（1.1）
4. 添加简单拒绝选项（1.2）

第二阶段（主要更新 - 高优先级）：
5. 宗主国战争领导者控制（3.1）
6. 简单距离 + 叛乱规模检查（2.1, 2.2）
7. 防御性战争的军事通行权例外（解决拜占庭场景和一般战争僵局）
   - 通用修复：考虑允许战争领导者在防御性战争期间从盟友请求军事通行权
   - 或：对从盟友请求通行权的防御性战争参与者的 block_when_at_war = yes 例外
   - 这解决了拜占庭场景以及许多其他防御方无法到达攻击方的战争僵局情况

第三阶段（可选增强）：
8. 简化决策系统（4.1, 4.2, 4.3）

简化方法的好处
==============

1. 降低错误风险
- 更少的移动部件
- 更简单的逻辑 = 更容易测试
- 更少的边缘情况机会

2. 更容易平衡
- 简单阈值（距离、叛乱规模）
- 如果需要，易于调整
- 无复杂交互

3. 更快的实施
- 使用现有游戏系统
- 最少的新代码
- 可以快速测试

4. 仍然符合历史
- 距离检查防止荒谬情况
- 叛乱规模检查允许大型叛乱（如美国独立战争）
- 拒绝选项给玩家控制权

5. 不易利用
- 简单规则更难利用
- 无复杂系统可游戏
- 清晰的边界

示例：简化工作流程
==================

场景：法国领土上的卡斯蒂利亚民族主义叛乱

步骤1：叛乱AI预评估
- 检查叛乱规模：法国人口的8%（中等）
- 检查到卡斯蒂利亚的距离：500公里（在2000阈值内）
- 检查土地渴望：卡斯蒂利亚对法国领土的 conquer_desire > 10
- 检查飞地：领土将与卡斯蒂利亚的现有领土连接
- 卡斯蒂利亚通过所有检查，发送请求

步骤2：卡斯蒂利亚收到请求
- 弹窗："支持卡斯蒂利亚爱国者对抗法国的战争？"
- 玩家看到：距离（500公里）、叛乱规模（法国的8%）、战略价值（法国是对手）、军事通行权（可行 - 与法国接壤）
- 选项："是" / "否"

步骤3：如果玩家选择"是"
- 卡斯蒂利亚在叛乱爆发时加入战争
- 无撕停战惩罚（豁免）
- 如果成功可以获得领土

步骤4：如果玩家选择"否"
- 卡斯蒂利亚不加入
- 无惩罚
- 叛乱在没有卡斯蒂利亚的情况下继续

结果：简单、清晰、历史上合理、低错误风险。

游戏设置选项
====================

为了让玩家控制这个机制，添加游戏设置，在开始新游戏前可在游戏规则菜单中访问：

1. "忽略所有叛乱支援请求"（默认：关闭）
   - 如果启用：不会向玩家发送任何叛乱支援请求
   - AI国家仍会收到请求（但可以根据距离、土地渴望和飞地检查拒绝）
   - 适用于觉得这个机制烦人或可被利用的玩家

2. "允许飞地附庸"（默认：开启）
   - 如果启用：玩家可以支持会创建飞地附庸（不连接领土）的叛乱
   - 如果关闭：玩家不会收到会创建飞地附庸的叛乱的支援请求
   - 注意：AI总是拒绝飞地附庸（它们不知道如何有效利用它们）
   - 适用于想要战略飞地附庸的玩家（例如，用于CB创建、定位）

注意：距离、军事通行权和土地渴望检查仍然适用于玩家和AI。飞地检查是唯一在玩家和AI之间不同的检查。

建议的通用性
================================

哪些修复是归并国特定的 vs. 普遍适用的：

归并国特定（仅适用于归并国机制）：
- 在召唤同文化国家之前进行距离检查（1.1）
- 叛乱规模评估（2.1）
- 归并国支援请求的拒绝选项（1.2）
- 防止过多通知的预评估（2.1, 2.2）

普遍适用（可以使所有战争受益）：
- 豁免强制参与的惩罚（1.3）- 可以适用于任何强制参战
- 宗主国战争领导者控制（3.1）- 可以适用于任何附庸内战
- 战争期间的军事通行权例外（第二阶段，第7项）- 这是一个影响所有战争的通用游戏机制问题：
  * block_when_at_war = yes 阻止所有战争期间的所有军事通行权请求
  * 这在许多场景中造成僵局，不仅仅是归并国战争
  * 考虑：允许在防御性战争期间从盟友/中立国家请求军事通行权
  * 或：允许战争领导者在防御性战争中从盟友请求通行权
  * 这将解决拜占庭场景以及许多其他防御方无法到达攻击方的战争僵局情况

给Paradox的思考
=============================

1. 战争期间的军事通行权：当前的 block_when_at_war = yes 造成防御方无法到达攻击方的僵局。考虑以下例外：
   - 防御性战争从盟友请求通行权
   - 战争领导者从盟友请求通行权
   - 中立国家向防御方授予通行权

2. 强制参战的惩罚：目前，强制参战（联盟、附庸、归并国召唤）可能触发撕停战和联统破裂。考虑：
   - 标志系统以豁免强制参与者的惩罚
   - 可以适用于所有强制参战，不仅仅是归并国

3. 停战与叛乱支援：是否应该排除与防御方有活跃停战的国家作为叛乱支持者？例如，如果卡斯蒂利亚与法国有停战，卡斯蒂利亚叛乱者请求卡斯蒂利亚支持他们对抗法国，这是否被视为撕停战？
   - 选项A：在预评估期间跳过有活跃停战的国家（完全防止选择）
   - 选项B：允许选择但豁免撕停战惩罚（已建议）
   - 这是一个需要考虑停战机制和历史先例的设计问题

4. 附庸内战的领导权：当宗主国被拖入附庸的内战时，宗主国应该是战争领导者以保持控制。这适用于所有附庸内战。

5. 基于距离的外交行动：归并国机制突出了一个更广泛的问题：国家在承诺外交行动之前应该评估可行性（距离、通行权、后勤、土地渴望）。这一原则可以适用于：
   - 联盟召唤参战
   - 保证激活
   - 干预提议
   - 注意：游戏已有AI用于扩张决策的 conquer_desire 函数 - 这可以用于归并国支援评估

6. 防御方获胜条件：当防御方无法到达攻击方时，他们的唯一选择是被动的（持续战争分数、战争疲惫）。考虑：
   - 孤立防御方的替代战争分数来源
   - 海上封锁有效性
   - 经济战机制

7. 关于大型独立运动的说明：游戏已经有一个机制用于导致独立国家（而非附庸）的大型独立运动：殖民地独立战争。殖民地国家可以宣布独立并寻求与其宗主国的对手结盟。这与归并国叛乱是分开的，归并国叛乱是想要加入附近相同文化国家并成为附庸的民族主义/文化型叛乱。本文档中的建议专注于修复核心归并国机制。

关于当前AI宣战机制的说明
=============================

根据代码分析，当前AI宣战机制：
- 使用 conquer_desire 函数评估目标，该函数考虑：
  * 距离（AI_CONQUER_DESIRE_DISTANCE_BASE = 200，距离惩罚，首都距离）
  * 国家规模（AI_CONQUER_DESIRE_DISTANCE_PER_COUNTRY_SIZE = 0.5）
  * 时代（AI_CONQUER_DESIRE_DISTANCE_PER_AGE = 50）
  * 通过附庸到达的惩罚（AI_CONQUER_DESIRE_THROUGH_SUBJECT_MULT = 0.5）
- **不**在宣战前明确检查军事/食物通行权
- AI可以在宣战后使用 violate_sovereignty 行动在战争期间获得通行权，但这仅对军事霸权可用（全球仅有一个，从第3时代/1437年起可用，前两个时代不可用）
- 这意味着对归并国支援的通行权检查将比常规宣战更严格，这是合理的，因为归并国支援是强制参与

战争参与者通行权：当国家一起参战（is_fighting_war_together_with）时，它们自动与所有战争参与者共享军事和食物通行权。联盟关系包括 military_access = yes，游戏自动授予所有战争参与者通行权。这意味着加入战争的盟友将自动提供通行权，但如果无法召唤盟友或盟友不加入，问题仍然存在。

结论
==========

这种简化方法：
- 修复关键归并国特定问题
- 识别通用游戏机制问题（军事通行权、强制参与）
- 保持核心历史准确性
- 最小化复杂性
- 降低错误和利用风险
- 使用现有游戏系统
- 可以快速实施

这个简化方法提供了一个坚实的基础，如果需要，可以稍后在此基础上构建，同时立即修复最关键的问题。通用修复（军事通行权、强制参与惩罚、宗主国控制）将使整个游戏受益，而不仅仅是归并国场景。
